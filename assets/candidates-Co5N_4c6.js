import{e as h,b as C,a as p,d as r,q as d,o as m,l as g,u as T,s as y,h as N,w as u,i as B,j as E,f as A,r as R,k as U,m as P,g as q,n as z,p as j,t as v}from"./index-Cn49cqZF.js";import{s as D,c as L,a as $}from"./sanitize-ted6m3Jb.js";const k=[{value:"new",label:"New",color:"primary"},{value:"contacted",label:"Contacted",color:"info"},{value:"awaiting_response",label:"Awaiting Response",color:"warning"},{value:"availability_confirmed",label:"Availability Confirmed",color:"success"},{value:"interview_scheduled",label:"Interview Scheduled",color:"primary"},{value:"interview_complete",label:"Interview Complete",color:"info"},{value:"trial_scheduled",label:"Trial Scheduled",color:"primary"},{value:"trial_complete",label:"Trial Complete",color:"info"},{value:"awaiting_approval",label:"Awaiting Approval",color:"warning"},{value:"approved",label:"Approved",color:"success"},{value:"rejected",label:"Rejected",color:"error"},{value:"withdrawn",label:"Withdrawn",color:"gray"}],O=[{value:"indeed",label:"Indeed"},{value:"direct",label:"Direct Application"},{value:"referral",label:"Referral"},{value:"linkedin",label:"LinkedIn"},{value:"website",label:"Company Website"},{value:"walk_in",label:"Walk-in"},{value:"other",label:"Other"}],i="candidates";async function W(e,t){const n=Date.now(),a=e.name.replace(/[^a-zA-Z0-9.-]/g,"_"),s=`cvs/${t}/${n}_${a}`,o=R(j,s);return await U(o,e),{cvUrl:await P(o),cvFileName:e.name,cvStoragePath:s}}async function F(e){if(!e)return;const t=R(j,e);try{await z(t)}catch(n){console.error("Error deleting CV:",n)}}async function Z(e,t){const n=p(r,i),a=D(e);L(JSON.stringify(e))&&console.warn("Suspicious content detected in candidate data, sanitising...");const s={firstName:a.firstName,lastName:a.lastName,email:a.email,phone:a.phone,address:a.address||null,postcode:a.postcode||null,status:"new",jobId:e.jobId||null,jobTitle:e.jobTitle||null,cvUrl:e.cvUrl||null,cvFileName:e.cvFileName||null,cvStoragePath:e.cvStoragePath||null,notes:a.notes||null,source:a.source||null,parsedData:e.parsedData||null,entityId:e.entityId||null,branchId:e.branchId||null,createdBy:t,createdAt:y(),updatedAt:y()};return{id:(await A(n,s)).id,...s}}async function x(e){const t=h(r,i,e),n=await q(t);return n.exists()?{id:n.id,...n.data()}:null}function G(e,t){const n=h(r,i,e);return C(n,a=>{a.exists()?t({id:a.id,...a.data()}):t(null)},a=>{console.error("Error subscribing to candidate:",a),t(null)})}const b=20;function J(e,t={}){const n=p(r,i);let a=d(n,m("createdAt","desc"),g(b));return t.status&&t.status!=="all"&&(a=d(n,u("status","==",t.status),m("createdAt","desc"),g(b))),t.jobId&&t.jobId!=="all"&&(a=d(n,u("jobId","==",t.jobId),m("createdAt","desc"),g(b))),C(a,s=>{const o=s.docs.map(f=>({id:f.id,...f.data()})),c=s.docs[s.docs.length-1]||null,l=s.docs.length===b;e({candidates:o,lastDoc:c,hasMore:l})},s=>{console.error("Error subscribing to candidates:",s),e({candidates:[],lastDoc:null,hasMore:!1,error:s})})}async function H(e,t={}){const n=p(r,i);let a=[m("createdAt","desc")];t.status&&t.status!=="all"&&(a=[u("status","==",t.status),...a]),t.jobId&&t.jobId!=="all"&&(a=[u("jobId","==",t.jobId),...a]),e&&a.push(B(e)),a.push(g(b));const s=d(n,...a),o=await E(s),c=o.docs.map(w=>({id:w.id,...w.data()})),l=o.docs[o.docs.length-1]||null,f=o.docs.length===b;return{candidates:c,lastDoc:l,hasMore:f}}async function K(e,t){const n=h(r,i,e),a={...t,updatedAt:y()};return await T(n,a),{id:e,...a}}async function Q(e){const t=await x(e);t?.cvStoragePath&&await F(t.cvStoragePath);const n=h(r,i,e);await N(n)}async function X(){const e=p(r,i),[t,n,a,s,o]=await Promise.all([v(d(e)),v(d(e,u("status","==","new"))),v(d(e,u("status","==","approved"))),v(d(e,u("status","==","rejected"))),v(d(e,u("status","==","withdrawn")))]),c=t.data().count,l=n.data().count,f=a.data().count,w=s.data().count+o.data().count,_=c-l-f-w;return{total:c,new:l,in_progress:_,approved:f,rejected:w}}async function Y(e,t,n,a){const s=p(r,i,e,"notes"),c={content:$(t),createdBy:n,createdByName:a||"Unknown",createdAt:y()},l=await A(s,c);return await I(e,{type:"note_added",description:"Added a note",createdBy:n,createdByName:a}),{id:l.id,...c}}function ee(e,t){const n=p(r,i,e,"notes"),a=d(n,m("createdAt","desc"));return C(a,s=>{const o=s.docs.map(c=>({id:c.id,...c.data()}));t(o)},s=>{console.error("Error subscribing to notes:",s)})}async function te(e,t){const n=h(r,i,e,"notes",t);await N(n)}async function I(e,t){const n=p(r,i,e,"activity"),a={type:t.type,description:t.description,metadata:t.metadata||null,createdBy:t.createdBy,createdByName:t.createdByName||"System",createdAt:y()};return{id:(await A(n,a)).id,...a}}function ae(e,t){const n=p(r,i,e,"activity"),a=d(n,m("createdAt","desc"),g(50));return C(a,s=>{const o=s.docs.map(c=>({id:c.id,...c.data()}));t(o)},s=>{console.error("Error subscribing to activity:",s)})}async function ne(e,t,n,a,s){const o=S(t).label,c=S(n).label;await I(e,{type:"status_change",description:`Status changed from ${o} to ${c}`,metadata:{oldStatus:t,newStatus:n},createdBy:a,createdByName:s})}function S(e){return k.find(n=>n.value===e)||{value:e,label:e,color:"gray"}}function se(e){return O.find(n=>n.value===e)?.label||e||"Unknown"}function oe(e){return`${e.firstName||""} ${e.lastName||""}`.trim()||"Unknown"}function ce(e){const t=e.firstName?.[0]||"",n=e.lastName?.[0]||"";return(t+n).toUpperCase()||"?"}export{O as C,b as P,I as a,ce as b,ee as c,ae as d,oe as e,k as f,S as g,se as h,Y as i,te as j,W as k,ne as l,Q as m,Z as n,J as o,H as p,X as q,G as s,K as u};
