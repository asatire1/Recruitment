import{B as le,y as o,g as C,e as j,d as u,q as re,a as $,w as ce,j as me,x as e,C as ue,D as ge,E as _,F as he,G as be,s as k,f as P,u as Q}from"./index-NO_tzWV3.js";import{C as ye}from"./calendar-a-ysl3sN.js";import{C as fe}from"./clock-Cie1cDXt.js";import{C as ke}from"./chevron-right-Df6H1ViZ.js";function Ne(){const{token:S}=le(),[J,z]=o.useState(!0),[E,b]=o.useState(null),[t,K]=o.useState(null),[c,V]=o.useState(null),[G,X]=o.useState([]),[n,H]=o.useState(null),[m,I]=o.useState(null),[T,Z]=o.useState(new Date),[O,F]=o.useState(!1),[W,Y]=o.useState(!1),[x,q]=o.useState(null);o.useEffect(()=>{ee()},[S]);const ee=async()=>{try{z(!0),b(null);const a=await C(j(u,"bookingLinks",S));if(!a.exists()){b("This booking link is invalid or has expired.");return}const i=a.data();if(i.expiresAt&&i.expiresAt.toDate()<new Date){b("This booking link has expired. Please request a new one.");return}if(i.used){b("This booking link has already been used."),q(i.bookedSlot),Y(!0);return}const d=await C(j(u,"candidates",i.candidateId)),y=d.exists()?d.data():null;let f=null;if(i.jobId){const g=await C(j(u,"jobs",i.jobId));f=g.exists()?g.data():null}const r=await C(j(u,"settings","bookingAvailability"));if(!r.exists()){b("Booking is not configured. Please contact the recruiter.");return}const h=r.data()[i.type];if(!h?.enabled){b(`Online booking for ${i.type}s is currently disabled.`);return}const D=re($(u,"interviews"),ce("status","in",["scheduled","confirmed"])),l=(await me(D)).docs.map(g=>({id:g.id,...g.data()}));K({...i,candidate:y,job:f}),V(h),X(l)}catch(a){console.error("Error loading booking data:",a),b("Failed to load booking information. Please try again.")}finally{z(!1)}},ae=o.useMemo(()=>{if(!c)return[];const a=T.getFullYear(),i=T.getMonth(),d=new Date(a,i,1),y=new Date(a,i+1,0),f=d.getDay()===0?6:d.getDay()-1,r=[],v=new Date;v.setHours(0,0,0,0);const h=new Date;h.setDate(h.getDate()+c.bookingWindow);for(let s=f-1;s>=0;s--){const l=new Date(a,i,-s);r.push({date:l,isCurrentMonth:!1,isAvailable:!1})}for(let s=1;s<=y.getDate();s++){const l=new Date(a,i,s),g=l.getDay(),M=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][g],p=c.days[M],N=l.toISOString().split("T")[0],L=l>=v&&l<=h&&p?.enabled&&!c.excludedDates?.includes(N);r.push({date:l,isCurrentMonth:!0,isAvailable:L,daySettings:p})}const D=42-r.length;for(let s=1;s<=D;s++){const l=new Date(a,i+1,s);r.push({date:l,isCurrentMonth:!1,isAvailable:!1})}return r},[T,c]),A=o.useMemo(()=>{if(!n||!c)return[];const a=n.getDay(),d=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][a],y=c.days[d];if(!y?.enabled)return[];const f=[],r=c.slotDuration;return n.toISOString().split("T")[0],y.slots.forEach(({start:v,end:h})=>{const[D,s]=v.split(":").map(Number),[l,g]=h.split(":").map(Number);let w=D*60+s;const M=l*60+g;for(;w+r<=M;){const p=Math.floor(w/60),N=w%60,L=`${p.toString().padStart(2,"0")}:${N.toString().padStart(2,"0")}`,B=new Date(n);B.setHours(p,N,0,0);const oe=G.some(U=>(U.dateTime?.toDate?.()||new Date(U.dateTime)).getTime()===B.getTime()),de=B<=new Date;!oe&&!de&&f.push({time:L,display:te(p,N),dateTime:B}),w+=r}}),f},[n,c,G]),te=(a,i)=>{const d=a>=12?"pm":"am";return`${a>12?a-12:a===0?12:a}:${i.toString().padStart(2,"0")}${d}`},ie=a=>{a.isAvailable&&(H(a.date),I(null))},ne=a=>{I(a)},se=async()=>{if(!(!m||!t)){F(!0);try{const a={candidateId:t.candidateId,candidateName:t.candidate?`${t.candidate.firstName} ${t.candidate.lastName}`:"Unknown",jobId:t.jobId||null,jobTitle:t.job?.title||t.jobTitle||null,type:t.type,dateTime:m.dateTime,duration:c.slotDuration,status:"scheduled",location:t.location||"TBC",bookedBy:"candidate",bookingToken:S,createdAt:k(),updatedAt:k()},i=await P($(u,"interviews"),a);await Q(j(u,"bookingLinks",S),{used:!0,usedAt:k(),interviewId:i.id,bookedSlot:{date:n.toISOString().split("T")[0],time:m.time,display:m.display}}),t.candidateId&&(await Q(j(u,"candidates",t.candidateId),{status:"interviewing",statusChangedAt:k(),updatedAt:k()}),await P($(u,"candidates",t.candidateId,"activity"),{type:"interview_scheduled",description:`${t.type==="interview"?"Interview":"Trial shift"} self-booked for ${n.toLocaleDateString("en-GB")} at ${m.display}`,performedBy:"Candidate (self-service)",timestamp:k()}),await P($(u,"notifications"),{type:"booking_confirmed",title:"New Booking",message:`${t.candidate?.firstName||"A candidate"} ${t.candidate?.lastName||""} booked ${t.type==="interview"?"an interview":"a trial shift"} for ${n.toLocaleDateString("en-GB")} at ${m.display}`,candidateId:t.candidateId,candidateName:t.candidate?`${t.candidate.firstName} ${t.candidate.lastName}`:"Unknown",interviewId:i.id,read:!1,createdAt:k()})),q({date:n.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long",year:"numeric"}),time:m.display,type:t.type,location:t.location||"To be confirmed"}),Y(!0)}catch(a){console.error("Error confirming booking:",a),alert("Failed to confirm booking. Please try again.")}finally{F(!1)}}},R=a=>{Z(i=>{const d=new Date(i);return d.setMonth(d.getMonth()+a),d}),H(null),I(null)};return J?e.jsx("div",{className:"booking-page",children:e.jsx("div",{className:"booking-container",children:e.jsxs("div",{className:"booking-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading booking options..."})]})})}):E&&!W?e.jsx("div",{className:"booking-page",children:e.jsx("div",{className:"booking-container",children:e.jsxs("div",{className:"booking-error",children:[e.jsx(ue,{size:48}),e.jsx("h2",{children:"Unable to Book"}),e.jsx("p",{children:E})]})})}):W&&x?e.jsx("div",{className:"booking-page",children:e.jsx("div",{className:"booking-container",children:e.jsxs("div",{className:"booking-confirmed",children:[e.jsx("div",{className:"confirmed-icon",children:e.jsx(ge,{size:64})}),e.jsx("h2",{children:"Booking Confirmed!"}),e.jsxs("p",{children:["Your ",x.type==="interview"?"interview":"trial shift"," has been scheduled."]}),e.jsxs("div",{className:"confirmed-details",children:[e.jsxs("div",{className:"confirmed-detail",children:[e.jsx(ye,{size:20}),e.jsx("span",{children:x.date})]}),e.jsxs("div",{className:"confirmed-detail",children:[e.jsx(fe,{size:20}),e.jsx("span",{children:x.time})]}),e.jsxs("div",{className:"confirmed-detail",children:[e.jsx(_,{size:20}),e.jsx("span",{children:x.location})]})]}),e.jsxs("div",{className:"confirmed-note",children:[e.jsx("p",{children:"You will receive a confirmation message shortly."}),e.jsx("p",{children:"If you need to reschedule, please contact us directly."})]})]})})}):e.jsx("div",{className:"booking-page",children:e.jsxs("div",{className:"booking-container",children:[e.jsxs("div",{className:"booking-header",children:[e.jsxs("div",{className:"booking-logo",children:[e.jsx(_,{size:32}),e.jsx("span",{children:"Allied Pharmacies"})]}),e.jsxs("h1",{children:["Book Your ",t?.type==="interview"?"Interview":"Trial Shift"]}),t?.job&&e.jsxs("p",{className:"booking-job",children:[e.jsx(he,{size:16}),t.job.title," - ",t.job.location]})]}),e.jsxs("div",{className:"booking-content",children:[e.jsxs("div",{className:"booking-calendar",children:[e.jsxs("div",{className:"calendar-header",children:[e.jsx("button",{onClick:()=>R(-1),className:"calendar-nav",children:e.jsx(be,{size:20})}),e.jsx("h3",{children:T.toLocaleDateString("en-GB",{month:"long",year:"numeric"})}),e.jsx("button",{onClick:()=>R(1),className:"calendar-nav",children:e.jsx(ke,{size:20})})]}),e.jsx("div",{className:"calendar-weekdays",children:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(a=>e.jsx("div",{className:"calendar-weekday",children:a},a))}),e.jsx("div",{className:"calendar-days",children:ae.map((a,i)=>e.jsx("button",{className:`calendar-day ${a.isCurrentMonth?"":"other-month"} ${a.isAvailable?"available":"unavailable"} ${n?.getTime()===a.date.getTime()?"selected":""}`,onClick:()=>ie(a),disabled:!a.isAvailable,children:a.date.getDate()},i))})]}),e.jsxs("div",{className:"booking-times",children:[e.jsx("h3",{children:n?`Available times on ${n.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long"})}`:"Select a date to see available times"}),n&&A.length===0&&e.jsx("p",{className:"no-slots",children:"No available times on this date. Please select another date."}),A.length>0&&e.jsx("div",{className:"time-slots-grid",children:A.map(a=>e.jsx("button",{className:`time-slot-btn ${m?.time===a.time?"selected":""}`,onClick:()=>ne(a),children:a.display},a.time))})]})]}),m&&e.jsxs("div",{className:"booking-confirm",children:[e.jsxs("div",{className:"confirm-summary",children:[e.jsx("p",{children:e.jsx("strong",{children:t?.type==="interview"?"Interview":"Trial Shift"})}),e.jsxs("p",{children:[n.toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long",year:"numeric"})," at ",m.display]})]}),e.jsx("button",{className:"confirm-btn",onClick:se,disabled:O,children:O?"Confirming...":"Confirm Booking"})]})]})})}export{Ne as default};
